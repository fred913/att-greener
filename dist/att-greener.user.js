// ==UserScript==
// @name         ATT Greener
// @namespace    https://ft2.club/
// @version      0.1
// @description  Provide a better experience for AMLL TTML Tool users.
// @author       Sheng Fan
// @match        https://amll-ttml-tool.stevexmh.net/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=amll-ttml-tool.stevexmh.net
// @grant        none
// ==/UserScript==
!function(){"use strict";const t='div[role="menu"][data-state="open"]';var e,n,i;function s(t){const e={};for(const n of t)e[n.key]=n.value;return e}function o(t){const e=s(t);let n="";if(e.musicName)for(const t of e.musicName)n+=`[ti:${t}]\n`;if(e.isrc)for(const t of e.isrc)n+=`[isrc:${t}]\n`;if(e.album)for(const t of e.album)n+=`[al:${t}]\n`;if(e.artists)for(const t of e.artists)n+=`[ar:${t}]\n`;if(e.ncmMusicId)for(const t of e.ncmMusicId)n+=`[ncm-id:${t}]\n`;if(e.qqMusicId)for(const t of e.qqMusicId)n+=`[qqmusic-id:${t}]\n`;if(e.spotifyId)for(const t of e.spotifyId)n+=`[spotify-id:${t}]\n`;if(e.appleMusicId)for(const t of e.appleMusicId)n+=`[applemusic-id:${t}]\n`;if(e.ttmlAuthorGithubLogin&&e.ttmlAuthorGithub){const t=e.ttmlAuthorGithubLogin[0];n+=`[by:${t}]\n`,n+=`[by-github-login:${t}]\n`,n+=`[by-github-id:${e.ttmlAuthorGithub[0]}]\n`}return n}!function(t){class e{static max(...t){return new e(Math.max(...t.filter((t=>null!==t)).map((t=>t.milliSeconds))))}static min(...t){return new e(Math.min(...t.filter((t=>null!==t)).map((t=>t.milliSeconds))))}constructor(t){this.milliSeconds=0,this.milliSeconds=t}seconds(){return this.milliSeconds/1e3}formatted(){const t=Math.floor(this.seconds()),e=t%60;return`${Math.floor(t/60)}:${e<10?"0":""}${e}`}}var n,i;t.Timestamp=e,(n=t.VoiceAgentType||(t.VoiceAgentType={})).Vocal="vocal",n.BackgroundVocal="background-vocal",n.Other="other",(i=t.LineAnnotationRole||(t.LineAnnotationRole={})).Prononciation="pron",i.Translation="trans";class s{constructor(t){this.syllables=t.syllables,this.voiceAgent=t.voiceAgent,this.annotations=t.annotations}toLineSyncedLine(){const t=this.syllables.map((t=>t.text)).join(""),n=e.min(...this.syllables.filter((t=>0!=t.start?.milliSeconds||0!=t.end?.milliSeconds||""!=t.text.trim())).map((t=>t.start))),i=e.max(...this.syllables.filter((t=>0!=t.start?.milliSeconds||0!=t.end?.milliSeconds||""!=t.text.trim())).map((t=>t.end)));return new o({text:t,start:n,end:i,voiceAgent:this.voiceAgent,annotations:this.annotations})}extractAnnotations(t){return this.toLineSyncedLine().extractAnnotations(t)}}t.SyllableSyncedLine=s;class o{static checkOverlap(t,e){if(null===t.start||null===t.end||null===e.start||null===e.end)return!1;return t.start.milliSeconds<e.end.milliSeconds&&e.start.milliSeconds<t.end.milliSeconds}static fromText(t){return new o({text:t})}constructor(t){this.text=t.text,this.start=t.start||null,this.end=t.end||null,this.voiceAgent=t.voiceAgent||null,this.annotations=t.annotations||[]}extractAnnotations(t){return this.annotations.filter((e=>e.role===t)).map((t=>{const e=t.line;return e.start=this.start,e.end=this.end,e}))}}t.LineSyncedLine=o,(t.Utils||(t.Utils={})).extractLineAnnotations=function(t,e){return t.flatMap((t=>t instanceof s||t instanceof o?t.extractAnnotations(e):[]))}}(e||(e={})),function(t){var n,i,s,o;n=t.Abstraction||(t.Abstraction={}),i=n.ALRC||(n.ALRC={}),(s=i.ALRCStylePosition||(i.ALRCStylePosition={}))[s.Undefined=0]="Undefined",s[s.Left=1]="Left",s[s.Center=2]="Center",s[s.Right=3]="Right",(o=i.ALRCStyleAccent||(i.ALRCStyleAccent={}))[o.Normal=0]="Normal",o[o.Background=1]="Background",o[o.Whisper=2]="Whisper",o[o.Emphasise=3]="Emphasise",function(n){function i(t){let n="",i=null;const s=[],o=[];let l=0;for(const n of t){const t=(n.voiceAgent?.type==e.VoiceAgentType.BackgroundVocal?6:3)+(2!=n.voiceAgent?.n?1:2);o.push(t);const r=[];if(n instanceof e.SyllableSyncedLine)for(const t of n.syllables)i=e.Timestamp.min(i,t.start),r.push({text:t.text,start:t.start?.milliSeconds||0,end:t.end?.milliSeconds||0});else n instanceof e.LineSyncedLine&&(i=n.start,r.push({text:n.text,start:n.start?.milliSeconds||0,end:n.end?.milliSeconds||0}));if(s.push(r),l>0&&null!=i){const t=s[l-1];t instanceof e.LineSyncedLine&&(t.end=i)}l+=1}l=0;for(const t of s){n+=`[${o[l]}]`;for(const e of t)n+=`${e.text}(${e.start},${e.end-e.start})`;n+="\n",l+=1}return n.trim()}function s(t){let n="";for(const i of t){let t;t=i instanceof e.SyllableSyncedLine?i.toLineSyncedLine():i;const s=t.start;if(s){const e=Math.floor(s.milliSeconds/6e4),i=Math.floor(s.milliSeconds%6e4/1e3),o=s.milliSeconds%1e3;n+=`[${e.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}.${o.toString().padStart(3,"0")}]${t.text}\n`}}return n.trim()}function o(t){let n="";for(const i of t){let t;t=i instanceof e.SyllableSyncedLine?i.toLineSyncedLine():i;const s=t.start,o=t.end;s&&(n+=`[${Math.round(s.milliSeconds)},${Math.round(o?.milliSeconds||0)}]${t.text}\n`)}return n.trim()}function l(t){let n="";for(const i of t){let t;t=i instanceof e.SyllableSyncedLine?i.toLineSyncedLine():i;const s=t.start,o=t.end,l=o?.milliSeconds||null,r=l&&s?l-s.milliSeconds:null;if(i instanceof e.SyllableSyncedLine){if(s){n+=`[${Math.round(s.milliSeconds)},${Math.round(r||0)}]`;for(const t of i.syllables){const e=t.end&&t.start?t.end.milliSeconds-t.start.milliSeconds:null;n+=`${t.text}(${Math.round(t.start?.milliSeconds||0)},${Math.round(e||0)})`}n+="\n"}}else i instanceof e.LineSyncedLine&&s&&(n+=`[${Math.round(s.milliSeconds)},${Math.round(r||0)}]${t.text}(${Math.round(s.milliSeconds)},${Math.round(r||0)})\n`)}return n.trim()}function r(t){let n="";for(const i of t){let t;t=i instanceof e.SyllableSyncedLine?i.toLineSyncedLine():i;const s=t.start,o=t.end,l=o?.milliSeconds||null,r=l&&s?l-s.milliSeconds:null;if(i instanceof e.SyllableSyncedLine){if(s){n+=`[${Math.round(s.milliSeconds)},${Math.round(r||0)}]`;for(const t of i.syllables){const e=t.end&&t.start?t.end.milliSeconds-t.start.milliSeconds:null;n+=`(${Math.round(t.start?.milliSeconds||0)},${Math.round(e||0)},0)${t.text}`}n+="\n"}}else i instanceof e.LineSyncedLine&&s&&(n+=`[${Math.round(s.milliSeconds)},${Math.round(r||0)}](${Math.round(s.milliSeconds)},${Math.round(r||0)},0)${t.text}\n`)}return n.trim()}function a(t){const n={li:{},si:null,h:{s:[]},l:[]};for(const i of t)if(i instanceof e.SyllableSyncedLine){const t={w:i.syllables.map((t=>({f:t.start?.milliSeconds||0,t:t.end?.milliSeconds||0,w:t.text}))),f:e.Timestamp.min(...i.syllables.map((t=>t.start))).milliSeconds,t:e.Timestamp.max(...i.syllables.map((t=>t.end))).milliSeconds};n.l.push(t)}else if(i instanceof e.LineSyncedLine){const t={tx:i.text,f:i.start?.milliSeconds||0,t:i.end?.milliSeconds||0};n.l.push(t)}return JSON.stringify(n)}function c(t){let n="",i=1;for(const s of t){let t;t=s instanceof e.SyllableSyncedLine?s.toLineSyncedLine():s;const o=t.start,l=t.end;if(o&&l){const s=new Date(o.milliSeconds),r=new Date(l.milliSeconds),a=`${s.getUTCHours().toString().padStart(2,"0")}:${s.getUTCMinutes().toString().padStart(2,"0")}:${s.getUTCSeconds().toString().padStart(2,"0")},${(o.milliSeconds%1e3).toString().padStart(3,"0")}`,c=`${r.getUTCHours().toString().padStart(2,"0")}:${r.getUTCMinutes().toString().padStart(2,"0")}:${r.getUTCSeconds().toString().padStart(2,"0")},${(l.milliSeconds%1e3).toString().padStart(3,"0")}`;let d=t.text.trim();t.voiceAgent&&t.voiceAgent.type==e.VoiceAgentType.BackgroundVocal&&(d=`(${d})`),n+=`${i}\n${a} --\x3e ${c}\n${d}\n\n`,i++}}return n.trim()}function d(n){let o="";const l=e.Utils.extractLineAnnotations(n,e.LineAnnotationRole.Translation),r=e.Utils.extractLineAnnotations(n,e.LineAnnotationRole.Prononciation);return o+=`[lyrics: ${t.Dumping.LQE.createLQEPartHeader({format:"Lyricify Syllable",language:"en-US"})}]\n`,o+=i(n).trimEnd(),o+="\n\n",l.length>0&&(o+=`\n[translation: ${t.Dumping.LQE.createLQEPartHeader({format:"LRC",language:"zh-CN"})}]\n`,o+=s(l).trimEnd(),o+="\n\n"),r.length>0&&(o+=`\n[pronunciation: ${t.Dumping.LQE.createLQEPartHeader({format:"LRC",language:"romaji"})}]\n`,o+=s(r).trimEnd(),o+="\n\n"),o.trim()}function u(t){function n(t){const e=Math.floor(t/6e4),n=Math.floor(t%6e4/1e3),i=t%1e3;return`[${e.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}.${i.toString().padStart(3,"0")}]`}let i="";for(const s of t){let t;t=s instanceof e.SyllableSyncedLine?s.toLineSyncedLine():s;const o=t.start,l=t.end;if(s instanceof e.SyllableSyncedLine){if(o&&l){let t=null;for(const e of s.syllables)e.start?.milliSeconds!=t&&(i+=n(e.start?.milliSeconds||0)),i+=e.text,i+=n(e.end?.milliSeconds||0),t=e.end?.milliSeconds||0;i+="\n"}}else s instanceof e.LineSyncedLine&&o&&l&&(i+=n(o.milliSeconds||0),i+=t.text,i+=n(l?.milliSeconds||0),i+="\n");for(const t of s.annotations)if(t.role==e.LineAnnotationRole.Translation){i+=t.line.text,i+="\n";break}}return i.trim()}function m(t){switch(t){case"lys":return i;case"lyl":return o;case"lrc":return s;case"qrc":return l;case"alrc":return a;case"srt":return c;case"yrc":return r;case"spl":return u;case"lqe":return d;case"ttml":case"ttml_amll":case"apple_syllable":case"krc":return null;default:return console.error(`Unsupported format: ${t}`),null}}(n.YRC||(n.YRC={})).createHeaderLines=function(t){const e=[],n=[];for(let e=0;e<t.lyricists.length;e++){const i=t.lyricists[e];e>0&&n.push({tx:"/"}),n.push({tx:i})}const i=[];for(let e=0;e<t.musicians.length;e++){const n=t.musicians[e];e>0&&i.push({tx:"/"}),i.push({tx:n})}return n.length>0&&e.push({t:0,c:[{tx:"作词: "},...n]}),i.length>0&&e.push({t:0,c:[{tx:"作曲: "},...i]}),e},(n.LQE||(n.LQE={})).createLQEPartHeader=function(t){return Object.entries(t).map((([t,e])=>`${t}@${e}`)).join(", ")},n.dumpLYS=i,n.dumpLRC=s,n.dumpLYL=o,n.dumpQRC=l,n.dumpYRC=r,n.dumpALRC=a,n.dumpSRT=c,n.dumpLQE=d,n.dumpSPL=u,n.dump=function(t,e){const n=m(t);return n?n(e):"[ERROR] Unsupported"},n.supportDump=function(t){return null!=m(t)}}(t.Dumping||(t.Dumping={}))}(n||(n={})),function(t){t.TYPES={lys:{displayName:"Lyricify Syllable",extensions:[".lys"]},lyl:{displayName:"Lyricify Lines",extensions:[".lyl"]},lqe:{displayName:"Lyricify Quick Export",extensions:[".lqe"]},lrc:{displayName:"LRC",extensions:[".lrc"]},alrc:{displayName:"ALRC",extensions:[".alrc"]},ttml:{displayName:"TTML (Original)",extensions:[".ttml"]},ttml_amll:{displayName:"TTML (AMLL Standards)",extensions:[".ttml"]},apple_syllable:{displayName:"Apple Syllable",extensions:[".json",".as",".asyl"]},yrc:{displayName:"YRC",extensions:[".yrc"]},qrc:{displayName:"QRC (Lyricify Standards)",extensions:[".qrc"]},krc:{displayName:"KRC",extensions:[".krc"]},srt:{displayName:"SRT",extensions:[".srt"]},spl:{displayName:"Salt Player Lyrics",extensions:[".lrc"]}},t.allTypes=Object.keys(t.TYPES),t.getLyricFormatDisplayName=function(e){return t.TYPES[e].displayName},t.getLyricFormatFileExtensions=function(e){return t.TYPES[e].extensions},t.requestReadLyricsFile=async function(t,e){const n=e.map((t=>`${t}`)),i=await window.showOpenFilePicker({types:[{description:t,accept:{"text/lyricsSpecific":[...n]}}]});if(i.length>0){const t=i[0],e=await t.getFile();return await e.text()}return null},t.requestWriteLyricsFile=async function(t,e,n,i){const s=e.map((t=>`${t}`)),o=await window.showSaveFilePicker({types:[{description:t,accept:{"text/lyricsSpecific":[...s]}}],suggestedName:i?.fileName||"lyrics"});if(o){const t=await o.createWritable();return await t.write(n),await t.close(),!0}return!1}}(i||(i={}));let l=null;const r=console.log,a=(...t)=>{if(2===t.length&&"string"==typeof t[0]){const[e,n]=t;"lyricLines atom changed"===e&&(r("got new lyricLines",n),l=n)}r(...t)};function c(){return l}function d(){const t=c();if(t){const n=t.lyricLines.map((t=>{const n=t.words.map((t=>({start:new e.Timestamp(t.startTime),end:new e.Timestamp(t.endTime),text:t.word,annotations:[]}))),i={n:t.isDuet?2:1,type:t.isBG?e.VoiceAgentType.BackgroundVocal:e.VoiceAgentType.Vocal},s=[];return t.translatedLyric&&s.push({role:e.LineAnnotationRole.Translation,line:new e.LineSyncedLine({text:t.translatedLyric})}),t.romanLyric&&s.push({role:e.LineAnnotationRole.Prononciation,line:new e.LineSyncedLine({text:t.romanLyric})}),new e.SyllableSyncedLine({syllables:n,voiceAgent:i,annotations:s})}));return console.log("currentLyricsToCoreLyric",n),n}return null}function u(t){return function(){const t=window;if(t.Toastify)return t.Toastify;throw new Error("Toastify hasn't loaded yet")}()(t)}function m(t){if(t instanceof e.SyllableSyncedLine){let e=1;for(;e<t.syllables.length;){" "==t.syllables[e].text&&(t.syllables.splice(e,1),t.syllables[e-1].text+=" "),e++}}if(t.voiceAgent?.type===e.VoiceAgentType.BackgroundVocal)if(t instanceof e.SyllableSyncedLine){for(;t.syllables[0].text.startsWith("(")||t.syllables[0].text.startsWith("（");)t.syllables[0].text=t.syllables[0].text.slice(1);for(;t.syllables[t.syllables.length-1].text.endsWith(")")||t.syllables[t.syllables.length-1].text.endsWith("）");)t.syllables[t.syllables.length-1].text=t.syllables[t.syllables.length-1].text.slice(0,-1);t.syllables[0].text=`(${t.syllables[0].text}`,t.syllables[t.syllables.length-1].text=`${t.syllables[t.syllables.length-1].text})`}else if(t instanceof e.LineSyncedLine){for(;t.text.startsWith("(")||t.text.startsWith("（");)t.text=t.text.slice(1);for(;t.text.endsWith(")")||t.text.endsWith("）");)t.text=t.text.slice(0,-1);t.text=`(${t.text})`}return t}const f=[{check(t){for(const e of t.itemsContainer.children)if("导出到 lyric"===e.innerText.toLowerCase().trim())return!0;return!1},inject(t){console.log(t),console.log("Detected exportAs menu, doing injection");for(let e=0;e<t.itemsContainer.children.length;){const n=t.itemsContainer.children[e];"导出到 ASS 字幕"===n.innerText.trim()?t.itemsContainer.removeChild(n):(n.innerText="导出到 ASS (.ass) (旧版选项)",e++)}const l=c(),r=d();function a(t,e){if(document.dispatchEvent(new PointerEvent("pointerdown")),!r)return void u({text:"当前无歌词数据，无法导出",duration:2600,close:!0,gravity:"top",position:"right",stopOnFocus:!0,style:{background:"rgb(18, 18, 18)",borderRadius:"16px",boxShadow:"unset"}}).showToast();let a,c="";switch(e){case"lyl":c+="[type:LyricifyLines]\n";case"lys":case"qrc":case"lrc":c+=o(l?.metadata||[]).trim(),c+="\n";break;case"yrc":c+=function(t){const e=s(t),i={lyricists:e.lyricists||[],musicians:e.musicians||e.artists||[]};return n.Dumping.YRC.createHeaderLines(i)}(l?.metadata||[]).map((t=>JSON.stringify(t))).join("\n"),c+="\n";break;case"lqe":c+="[Lyricify Quick Export]\n",c+="[version:1.0]\n",c+=o(l?.metadata||[]).trim(),c+="\n\n"}switch(e){case"lys":case"qrc":a=r.map(m);break;default:a=r}const d=c+n.Dumping.dump(e,a)+"",f=i.getLyricFormatFileExtensions(e),y=i.getLyricFormatDisplayName(e);"clipboard"===t?navigator.clipboard.writeText(d).then((()=>{u({text:`歌词内容已复制为 ${y} 格式`,duration:2600,close:!0,gravity:"top",position:"right",stopOnFocus:!0,style:{background:"rgb(18, 18, 18)",borderRadius:"16px",boxShadow:"unset"}}).showToast()})).catch((()=>{u({text:"复制失败",duration:2e3,close:!0,gravity:"top",position:"right",stopOnFocus:!0,style:{background:"rgb(18, 18, 18)",borderRadius:"16px",boxShadow:"unset"}}).showToast()})):i.requestWriteLyricsFile(i.getLyricFormatDisplayName(e),f,d,{fileName:"lyrics"}).then((t=>{u({text:t?`歌词已导出为 ${y} 格式`:"导出失败：已取消",duration:t?2600:1800,close:!0,gravity:"top",position:"right",stopOnFocus:!0,style:{background:"rgb(18, 18, 18)",borderRadius:"16px",boxShadow:"unset"}}).showToast()}))}function f(t,e,s){const o=i.getLyricFormatDisplayName(t),l=i.getLyricFormatFileExtensions(t),r=document.createElement("div");var c;return r.classList.add("rt-reset","rt-BaseMenuItem","rt-DropdownMenuItem"),r.tabIndex=-1,r.setAttribute("role","menuitem"),r.setAttribute("data-orientation","vertical"),r.setAttribute("data-radix-collection-item",""),r.innerText=s||`导出到 ${o} (${l.join(", ")})`,n.Dumping.supportDump(t)||(r.innerText+=" (尚未实现)"),(c=r).addEventListener("mouseover",(()=>{c.setAttribute("data-highlighted","true")})),c.addEventListener("mouseout",(()=>{c.removeAttribute("data-highlighted")})),c.addEventListener("blur",(()=>{c.removeAttribute("data-highlighted")})),r.addEventListener("click",(e=>{e instanceof MouseEvent&&0!==e.button||a("download",t)})),r.addEventListener("contextmenu",(e=>(e.preventDefault(),e.stopPropagation(),a("clipboard",t),!1))),r}for(const e of i.allTypes){if(!n.Dumping.supportDump(e))continue;const i=f(e);t.itemsContainer.appendChild(i)}if(r){const n=e.Utils.extractLineAnnotations(r,e.LineAnnotationRole.Translation);if(n.length>0){const e=f("lrc",0,"导出翻译为 LRC (.lrc)");t.itemsContainer.appendChild(e)}const i=e.Utils.extractLineAnnotations(r,e.LineAnnotationRole.Prononciation);if(i.length>0){const e=f("lrc",0,"导出音译为 LRC (.lrc)");t.itemsContainer.appendChild(e)}}}}];function y(t){if(t.dataset._injected)return;t.dataset._injected="true";const e=t.querySelector("div.rt-ScrollAreaViewport > div > div");if(!e)return void console.warn("Failed to find menu item container");const n={itemsContainer:e,menu:t};for(const t of f)t.check(n)&&t.inject(n)}(async function(){document.head.insertAdjacentHTML("beforeend",'<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">');const t=document.createElement("script");return t.src="https://cdn.jsdelivr.net/npm/toastify-js",document.body.appendChild(t),new Promise((e=>{t.onload=()=>{e(!0)}}))})().then((()=>{console.log=a,new MutationObserver((e=>{for(const n of e)for(const e of Array.from(n.addedNodes))if(e instanceof HTMLElement&&(e.matches(t)&&y(e),1==e.childNodes.length)){const n=e.firstChild;if(!(n instanceof HTMLElement))continue;n.matches(t)&&(console.log("Found Radix menu in the first child"),y(n))}})).observe(document.body,{childList:!0,subtree:!0}),u({text:"ATT Greener 加载成功\n当前功能：导出指定格式歌词\n测试版本，遇到问题欢迎在交流群反馈",duration:3e3,close:!0,gravity:"top",position:"right",stopOnFocus:!0,onClick:function(){},style:{background:"rgb(18, 18, 18)",borderRadius:"16px"}}).showToast()}))}();
